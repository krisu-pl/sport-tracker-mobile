"use strict";!function(){"use-strict";function t(t,n,e){t.state("login",{url:"/login","class":"login",templateUrl:"views/login.html",controller:"loginController"}).state("tracking",{url:"/tracking","class":"tracking",templateUrl:"views/tracking.html",controller:"trackingController"}),n.otherwise("/login")}var n=angular.module("sport-tracker-mobile",["ngCordova","ngStorage","ui.router"]);n.run(function(t){t.endpoint="http://192.168.43.4:3000/api/mobile"}),n.config(t)}(),angular.module("sport-tracker-mobile").service("APIService",function(t,n,e){function i(i,o){var r=arguments.length<=2||void 0===arguments[2]?null:arguments[2];return t(function(t,a){n({method:i,url:e.endpoint+o,data:r,withCredentials:!0}).then(function(n){t(n)},function(t){a(t)})})}this.login=function(t){return i("POST","/login",t)},this.getAllEvents=function(){return i("GET","/getAllEvents")},this.sendLocation=function(t){return i("POST","/sendLocation",t)}}),angular.module("sport-tracker-mobile").factory("DataService",function(t){return{setActiveEvent:function(n){t.activeEvent=n},getActiveEvent:function(){return t.activeEvent},setActiveParticipant:function(n){t.activeParticipant=n},getActiveParticipant:function(){return t.activeParticipant},setSessionKey:function(n){t.sessionKey=n},getSessionKey:function(){return t.sessionKey},clearData:function(){t.activeEvent={},t.activeParticipant={},t.sessionKey=""}}}),angular.module("sport-tracker-mobile").service("DeviceService",function(t,n,e,i){this.getCurrentPosition=function(){return n(function(n,e){var i={timeout:1e4,enableHighAccuracy:!0};t.getCurrentPosition(i).then(function(t){var e=t.coords.latitude.toFixed(5),i=t.coords.longitude.toFixed(5);n({lat:e,lng:i})},function(t){e(t)})})}}),angular.module("sport-tracker-mobile").controller("loginController",function(t,n,e,i,o){n.events=[],n.init=function(){i.getAllEvents().then(function(t){n.events=t.data})},n.onLogin=function(){var t={event_id:parseInt(n.event_id),starting_number:parseInt(n.starting_number),pin:parseInt(n.pin)},r=n.events.filter(function(t){return t.id==n.event_id});i.login(t).then(function(t){o.setActiveEvent(r[0]),o.setActiveParticipant(t.data.participant),o.setSessionKey(t.data.session_key),e.go("tracking")})}}),angular.module("sport-tracker-mobile").controller("trackingController",function(t,n,e,i,o,r,a,c){function l(){var t=u(),i="",o=function(){return e(function(t,n){c.getCurrentPosition().then(function(n){t(n)},function(t){n(t)})})},a=function(t){return e(function(e,i){var o={lat:t.lat,lng:t.lng,participant_event_id:n.participant.id,timestamp:moment().format("YYYY-MM-DD HH:mm:ss")};r.sendLocation(o).then(function(n){e({response:n,position:t})},function(t){i(t)})})};o().then(a).then(function(n){var e=(n.response,n.position);i="<p><b>"+t+"</b> - Location sent ("+e.lat+", "+e.lng+")</p>",p.prepend(i)})["catch"](function(n){console.error(n),i='<p class="error"><b>'+t+"</b> - "+n.data+"</p>",p.prepend(i)})}function u(){return moment().format("DD.MM.YYYY, HH:mm:ss")}function s(){function t(){var t=new Date,o=t-c,a="",l=void 0,u=void 0,s=void 0;o<0?(a="-",l=Math.ceil(o/r)*-1,u=Math.ceil(o%r/i)*-1,s=Math.ceil(o%i/e)*-1):(l=Math.floor(o/r),u=Math.floor(o%r/i),s=Math.floor(o%i/e)),n.data.eventTime=a+v(l)+":"+v(u)+":"+v(s)}var e=1e3,i=60*e,r=60*i,a=n.event.start_date,c=new Date(a);o(t,1e3)}function v(t){return("0"+t).slice(-2)}n.event={},n.participant={},n.data={eventActive:!1,trackingActive:!1,eventTime:"-"};var g=void 0,f=!1,p=angular.element(document.getElementById("tracking_bottom"));n.$watch("data.eventTime",function(t,e){"-"!=t.substr(0,1)&&(n.data.eventActive=!0,n.data.trackingActive&&!f&&(l(),g=o(l,1e4),f=!0))}),n.init=function(){n.event=a.getActiveEvent(),n.participant=a.getActiveParticipant(),(_.isEmpty(n.event)||_.isEmpty(n.participant))&&i.go("login"),s()},n.onStartTracking=function(){n.data.trackingActive=!0;var t=u(),e='<p class="info"><b>'+t+"</b> - Tracking enabled.</p>";p.prepend(e)},n.onStopTracking=function(){n.data.trackingActive=!1,o.cancel(g),f=!1;var t=u(),e='<p class="info"><b>'+t+"</b> - Tracking disabled.</p>";p.prepend(e)}});