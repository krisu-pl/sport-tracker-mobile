"use strict";!function(){"use-strict";function t(t,n,e){t.state("login",{url:"/login","class":"login",templateUrl:"views/login.html",controller:"loginController"}).state("tracking",{url:"/tracking","class":"tracking",templateUrl:"views/tracking.html",controller:"trackingController"}),n.otherwise("/login")}var n=angular.module("sport-tracker-mobile",["ngCordova","ngStorage","ui.router","cordovaHTTP"]);n.run(function(t){t.endpoint="http://178.62.21.70:3001/api/mobile"}),n.config(t)}(),angular.module("sport-tracker-mobile").service("APIService",function(t,n,e,i){function o(n,o){var a=arguments.length<=2||void 0===arguments[2]?null:arguments[2];return"post"==n?t(function(t,n){i.post(e.endpoint+o,{data:a,withCredentials:!0},function(n){t(n)},function(t){n(t)})}):"get"==n?t(function(t,n){i.get(e.endpoint+o,{data:a,withCredentials:!0},function(n){t(n)},function(t){n(t)})}):void 0}this.login=function(t){return o("POST","/login",t)},this.getAllEvents=function(){return o("GET","/getAllEvents")},this.sendLocation=function(t){return o("POST","/sendLocation",t)}}),angular.module("sport-tracker-mobile").factory("DataService",function(t){return{setActiveEvent:function(n){t.activeEvent=n},getActiveEvent:function(){return t.activeEvent},setActiveParticipant:function(n){t.activeParticipant=n},getActiveParticipant:function(){return t.activeParticipant},setSessionKey:function(n){t.sessionKey=n},getSessionKey:function(){return t.sessionKey},clearData:function(){t.activeEvent={},t.activeParticipant={},t.sessionKey=""}}}),angular.module("sport-tracker-mobile").service("DeviceService",function(t,n,e,i){this.getCurrentPosition=function(){return n(function(n,e){var i={timeout:1e4,enableHighAccuracy:!0};t.getCurrentPosition(i).then(function(t){var e=t.coords.latitude.toFixed(5),i=t.coords.longitude.toFixed(5);n({lat:e,lng:i})},function(t){e(t)})})}}),angular.module("sport-tracker-mobile").controller("loginController",function(t,n,e,i,o){n.events=[],n.init=function(){i.getAllEvents().then(function(t){n.events=t.data})},n.onLogin=function(){var t={event_id:parseInt(n.event_id),starting_number:parseInt(n.starting_number),pin:parseInt(n.pin)},a=n.events.filter(function(t){return t.id==n.event_id});i.login(t).then(function(t){o.setActiveEvent(a[0]),o.setActiveParticipant(t.data.participant),o.setSessionKey(t.data.session_key),e.go("tracking")})}}),angular.module("sport-tracker-mobile").controller("trackingController",function(t,n,e,i,o,a,r,c){function s(){return moment().format("DD.MM.YYYY, HH:mm:ss")}function l(){function t(){var t=new Date,o=t-c,r="",s=void 0,l=void 0,v=void 0;o<0?(r="-",s=Math.ceil(o/a)*-1,l=Math.ceil(o%a/i)*-1,v=Math.ceil(o%i/e)*-1):(s=Math.floor(o/a),l=Math.floor(o%a/i),v=Math.floor(o%i/e)),n.data.eventTime=r+u(s)+":"+u(l)+":"+u(v)}var e=1e3,i=60*e,a=60*i,r=n.event.start_date,c=new Date(r);o(t,1e3)}function u(t){return("0"+t).slice(-2)}n.event={},n.participant={},n.data={eventActive:!1,trackingActive:!1,eventTime:"-"};var v,d=void 0,p=!1,g=angular.element(document.getElementById("tracking_bottom"));document.addEventListener("deviceready",function(){v=window.BackgroundGeolocation,v.configure({desiredAccuracy:0,distanceFilter:10,stationaryRadius:50,locationUpdateInterval:1e3,fastestLocationUpdateInterval:5e3,pausesLocationUpdatesAutomatically:!1,activityType:"AutomotiveNavigation",activityRecognitionInterval:5e3,stopTimeout:5,debug:!0,stopOnTerminate:!1,startOnBoot:!0},function(t){console.log("BackgroundGeolocation ready: ",t)});var t=function(t){return e(function(e,i){var o={lat:t.latitude,lng:t.longitude,participant_event_id:n.participant.id,timestamp:moment().format("YYYY-MM-DD HH:mm:ss")};a.sendLocation(o).then(function(n){e({response:n,position:t})},function(t){i(t)})})},i=function(n,e){var i=s(),o="",a=n.coords;t(a).then(function(t){var n=(t.response,t.position);o="<p><b>"+i+"</b> - Location sent ("+n.latitude+", "+n.longitude+")</p>",g.prepend(o)})["catch"](function(t){console.error(t),o='<p class="error"><b>'+i+"</b> - "+t.data+"</p>",g.prepend(o)}),v.finish(e)},o=function(t){console.warn("- BackgroundGeoLocation error: ",t);var n=s(),e='<p class="error"><b>'+n+"</b> - "+t+"</p>";g.prepend(e)};v.on("location",i,o),v.on("motionchange",function(t){console.log("- onMotionChange: ",t)})}),n.$watch("data.eventTime",function(t,e){"-"!=t.substr(0,1)&&(n.data.eventActive=!0,n.data.trackingActive&&!p&&(p=!0))}),n.init=function(){n.event=r.getActiveEvent(),n.participant=r.getActiveParticipant(),(_.isEmpty(n.event)||_.isEmpty(n.participant))&&i.go("login"),l()},n.onStartTracking=function(){n.data.trackingActive=!0,v.start();var t=s(),e='<p class="info"><b>'+t+"</b> - Tracking enabled.</p>";g.prepend(e)},n.onStopTracking=function(){n.data.trackingActive=!1,v.stop(),o.cancel(d),p=!1;var t=s(),e='<p class="info"><b>'+t+"</b> - Tracking disabled.</p>";g.prepend(e)}});