"use strict";!function(){"use-strict";function t(t,n,e){t.state("login",{url:"/login","class":"login",templateUrl:"views/login.html",controller:"loginController"}).state("tracking",{url:"/tracking","class":"tracking",templateUrl:"views/tracking.html",controller:"trackingController"}),n.otherwise("/login")}var n=angular.module("sport-tracker-mobile",["ngCordova","ngStorage","ui.router"]);n.run(function(t){t.endpoint="http://178.62.21.70:3001/api/mobile"}),n.config(t)}(),angular.module("sport-tracker-mobile").service("APIService",function(t,n,e){function i(i,o){var a=arguments.length<=2||void 0===arguments[2]?null:arguments[2];return t(function(t,r){n({method:i,url:e.endpoint+o,data:a,withCredentials:!0}).then(function(n){t(n)},function(t){r(t)})})}this.login=function(t){return i("POST","/login",t)},this.getAllEvents=function(){return i("GET","/getAllEvents")},this.sendLocation=function(t){return i("POST","/sendLocation",t)}}),angular.module("sport-tracker-mobile").factory("DataService",function(t){return{setActiveEvent:function(n){t.activeEvent=n},getActiveEvent:function(){return t.activeEvent},setActiveParticipant:function(n){t.activeParticipant=n},getActiveParticipant:function(){return t.activeParticipant},setSessionKey:function(n){t.sessionKey=n},getSessionKey:function(){return t.sessionKey},clearData:function(){t.activeEvent={},t.activeParticipant={},t.sessionKey=""}}}),angular.module("sport-tracker-mobile").service("DeviceService",function(t,n,e,i){this.getCurrentPosition=function(){return n(function(n,e){var i={timeout:1e4,enableHighAccuracy:!0};t.getCurrentPosition(i).then(function(t){var e=t.coords.latitude.toFixed(5),i=t.coords.longitude.toFixed(5);n({lat:e,lng:i})},function(t){e(t)})})}}),angular.module("sport-tracker-mobile").controller("loginController",function(t,n,e,i,o){n.events=[],n.init=function(){i.getAllEvents().then(function(t){n.events=t.data})},n.onLogin=function(){var t={event_id:parseInt(n.event_id),starting_number:parseInt(n.starting_number),pin:parseInt(n.pin)},a=n.events.filter(function(t){return t.id==n.event_id});i.login(t).then(function(t){o.setActiveEvent(a[0]),o.setActiveParticipant(t.data.participant),o.setSessionKey(t.data.session_key),e.go("tracking")})}}),angular.module("sport-tracker-mobile").controller("trackingController",function(t,n,e,i,o,a,r,c){function u(t){var n=arguments.length<=1||void 0===arguments[1]?"":arguments[1],e=v();t='<p class="'+n+'"><b>'+e+"</b> - "+t+"</p>",h.prepend(t)}function l(t){console.log(t),u(t,"info")}function s(t){console.error(t),u(t,"error")}function v(){return moment().format("DD.MM.YYYY, HH:mm:ss")}function d(){function t(){var t=new Date,o=t-c,r="",u=void 0,l=void 0,s=void 0;o<0?(r="-",u=Math.ceil(o/a)*-1,l=Math.ceil(o%a/i)*-1,s=Math.ceil(o%i/e)*-1):(u=Math.floor(o/a),l=Math.floor(o%a/i),s=Math.floor(o%i/e)),n.data.eventTime=r+g(u)+":"+g(l)+":"+g(s)}var e=1e3,i=60*e,a=60*i,r=n.event.start_date,c=new Date(r);o(t,1e3)}function g(t){return("0"+t).slice(-2)}n.event={},n.participant={},n.data={eventActive:!1,trackingActive:!1,eventTime:"-"};var f,p=void 0,m=!1,h=angular.element(document.getElementById("tracking_bottom"));document.addEventListener("deviceready",function(){f=window.BackgroundGeolocation,f.configure({desiredAccuracy:0,distanceFilter:10,stationaryRadius:10,pausesLocationUpdatesAutomatically:!1,activityType:"Fitness",activityRecognitionInterval:5e3,stopTimeout:5,debug:!1},function(t){console.log("BackgroundGeolocation ready ",t),l("BackgroundGeolocation ready")});var t=function(t){return e(function(e,i){var o={lat:t.latitude,lng:t.longitude,participant_event_id:n.participant.id,timestamp:moment().format("YYYY-MM-DD HH:mm:ss")};a.sendLocation(o).then(function(n){e({response:n,position:t})},function(t){i(t)})})},i=function(n,e){var i=(v(),""),o=n.coords;t(o).then(function(t){var n=(t.response,t.position);i="Location sent ("+n.latitude.toFixed(5)+", "+n.longitude.toFixed(5)+")",u(i)})["catch"](function(t){s(t.data)}),f.finish(e)},o=function(t){s("BackgroundGeoLocation error"+t)};f.on("location",i,o),f.on("motionchange",function(t){l("MotionChange: "+t)})}),n.$watch("data.eventTime",function(t,e){"-"!=t.substr(0,1)&&(n.data.eventActive=!0,n.data.trackingActive&&!m&&(m=!0))}),n.init=function(){n.event=r.getActiveEvent(),n.participant=r.getActiveParticipant(),(_.isEmpty(n.event)||_.isEmpty(n.participant))&&i.go("login"),d()},n.onStartTracking=function(){n.data.trackingActive=!0,f.start(),l("Tracking enabled")},n.onStopTracking=function(){n.data.trackingActive=!1,f.stop(),o.cancel(p),m=!1,l("Tracking disabled")}});